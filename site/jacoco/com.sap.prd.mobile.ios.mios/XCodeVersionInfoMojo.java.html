<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>XCodeVersionInfoMojo.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Xcode Maven Plugin</a> &gt; <a href="index.html" class="el_package">com.sap.prd.mobile.ios.mios</a> &gt; <span class="el_source">XCodeVersionInfoMojo.java</span></div><h1>XCodeVersionInfoMojo.java</h1><pre class="source lang-java linenums">/*
 * #%L
 * xcode-maven-plugin
 * %%
 * Copyright (C) 2012 SAP AG
 * %%
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * #L%
 */
package com.sap.prd.mobile.ios.mios;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

import javax.xml.bind.JAXBException;

import org.apache.commons.io.FileUtils;
import org.apache.commons.io.IOUtils;
import org.apache.maven.artifact.Artifact;
import org.apache.maven.execution.MavenSession;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugin.MojoFailureException;
import org.apache.maven.project.MavenProjectHelper;
import org.sonatype.aether.RepositorySystem;
import org.sonatype.aether.RepositorySystemSession;
import org.sonatype.aether.repository.RemoteRepository;
import org.xml.sax.SAXException;

import com.sap.prd.mobile.ios.mios.CodeSignManager.ExecResult;
import com.sap.prd.mobile.ios.mios.CodeSignManager.ExecutionResultVerificationException;
import com.sap.prd.mobile.ios.mios.versioninfo.v_1_2_2.Dependency;

/**
 * Generates a &amp;lt;artifact-id&amp;gt;-&amp;lt;version&amp;gt;-version.xml for reproducibility reasons. This
 * versions.xml contains information about the scm location and revision of the built project and
 * all its dependencies. Expects a sync.info file in the root folder of the project as input.
 * 
 * 
 * The sync.info file is a property file and must contain the following entries: &lt;code&gt;
 * &lt;ul&gt;
 *   &lt;li&gt; port=PORT
 *   &lt;li&gt; depotpath=DEPOT_PATH
 *   &lt;li&gt; changelist=CHANGELIST
 * &lt;/ul&gt;
 * &lt;/code&gt;
 * 
 * 
 * 
 * PORT entry is the SCM server where the project is located. &lt;br&gt;
 * DEPOT_PATH is the path to the project on the SCM server. For Perforce projects, DEPOT_PATH has
 * the following format //DEPOT_PATH/... &lt;br&gt;
 * CHANGELIST is the revision synced.
 * 
 * 
 * @goal attach-version-info
 * @requiresDependencyResolution
 */
<span class="nc" id="L72">public class XCodeVersionInfoMojo extends BuildContextAwareMojo</span>
{

  /**
   * 
   * @parameter default-value=&quot;${session}&quot;
   * @required
   * @readonly
   */
  protected MavenSession mavenSession;

  /**
   * The entry point to Aether, i.e. the component doing all the work.
   * 
   * @component
   */
  protected RepositorySystem repoSystem;

  /**
   * The current repository/network configuration of Maven.
   * 
   * @parameter default-value=&quot;${repositorySystemSession}&quot;
   * @readonly
   */
  protected RepositorySystemSession repoSession;

  /**
   * The project's remote repositories to use for the resolution of project dependencies.
   * 
   * @parameter default-value=&quot;${project.remoteProjectRepositories}&quot;
   * @readonly
   */
  protected List&lt;RemoteRepository&gt; projectRepos;

  /**
   * @component
   */
  private MavenProjectHelper projectHelper;

  /**
   * @parameter expression=&quot;${sync.info.file}&quot; default-value=&quot;sync.info&quot;
   */
  private String syncInfo;

  /**
   * If &lt;code&gt;true&lt;/code&gt; the build fails if it does not find a sync.info file in the root directory
   * 
   * @parameter expression=&quot;${xcode.failOnMissingSyncInfo}&quot; default-value=&quot;false&quot;
   */
  private boolean failOnMissingSyncInfo;

  @Override
  public void execute() throws MojoExecutionException, MojoFailureException
  {

<span class="nc" id="L127">    final File syncInfoFile = new File(mavenSession.getExecutionRootDirectory(), syncInfo);</span>

<span class="nc bnc" id="L129" title="All 2 branches missed.">    if (!syncInfoFile.exists()) {</span>

<span class="nc bnc" id="L131" title="All 2 branches missed.">      if (failOnMissingSyncInfo)</span>
      {
<span class="nc" id="L133">        throw new MojoExecutionException(&quot;Sync info file '&quot; + syncInfoFile.getAbsolutePath()</span>
              + &quot;' not found. Please configure your SCM plugin accordingly.&quot;);
      }

<span class="nc" id="L137">      getLog().info(&quot;The optional sync info file '&quot; + syncInfoFile.getAbsolutePath()</span>
            + &quot;' not found. Cannot attach versions.xml to build results.&quot;);
<span class="nc" id="L139">      return;</span>
    }

<span class="nc" id="L142">    getLog().info(&quot;Sync info file found: '&quot; + syncInfoFile.getAbsolutePath() + &quot;'. Creating versions.xml file.&quot;);</span>

<span class="nc" id="L144">    final File versionsXmlFile = new File(project.getBuild().getDirectory(), &quot;versions.xml&quot;);</span>

<span class="nc" id="L146">    FileOutputStream os = null;</span>

    try {
<span class="nc" id="L149">      os = new FileOutputStream(versionsXmlFile);</span>

<span class="nc" id="L151">      new VersionInfoXmlManager().createVersionInfoFile(project.getGroupId(), project.getArtifactId(),</span>
            project.getVersion(), syncInfoFile, getDependencies(), os);

    }
<span class="nc" id="L155">    catch (IOException e) {</span>
<span class="nc" id="L156">      throw new MojoExecutionException(e.getMessage(), e);</span>
    }
    finally {
<span class="nc" id="L159">      IOUtils.closeQuietly(os);</span>
<span class="nc" id="L160">    }</span>

<span class="nc" id="L162">    final File versionsPlistFile = new File(project.getBuild().getDirectory(), &quot;versions.plist&quot;);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">    if (versionsPlistFile.exists()) {</span>
<span class="nc" id="L164">      versionsPlistFile.delete();</span>
    }
    try {
<span class="nc" id="L167">      new VersionInfoPListManager().createVersionInfoPlistFile(project.getGroupId(), project.getArtifactId(),</span>
            project.getVersion(), syncInfoFile, getDependencies(), versionsPlistFile);
    }
<span class="nc" id="L170">    catch (IOException e) {</span>
<span class="nc" id="L171">      throw new MojoExecutionException(e.getMessage(), e);</span>
<span class="nc" id="L172">    }</span>

    try {
<span class="nc bnc" id="L175" title="All 2 branches missed.">    if (PackagingType.getByMavenType(packaging) == PackagingType.APP)</span>
    {
      try
      {
<span class="nc" id="L179">        copyVersionsFilesAndSign();</span>
      }
<span class="nc" id="L181">      catch (IOException e) {</span>
<span class="nc" id="L182">        throw new MojoExecutionException(e.getMessage(), e);</span>
      }
<span class="nc" id="L184">      catch (ExecutionResultVerificationException e) {</span>
<span class="nc" id="L185">        throw new MojoExecutionException(e.getMessage(), e);</span>
      }
<span class="nc" id="L187">      catch (XCodeException e) {</span>
<span class="nc" id="L188">        throw new MojoExecutionException(e.getMessage(), e);</span>
<span class="nc" id="L189">      }</span>
    }
<span class="nc" id="L191">    } catch(PackagingType.UnknownPackagingTypeException ex) {</span>
<span class="nc" id="L192">      getLog().warn(&quot;Unknown packaing type detected.&quot;, ex);</span>
     
<span class="nc" id="L194">    }</span>

<span class="nc" id="L196">    projectHelper.attachArtifact(project, &quot;xml&quot;, &quot;versions&quot;, versionsXmlFile);</span>
<span class="nc" id="L197">    getLog().info(&quot;versions.xml '&quot; + versionsXmlFile + &quot; attached as additional artifact.&quot;);</span>

<span class="nc" id="L199">  }</span>

  private void copyVersionsFilesAndSign() throws IOException, ExecutionResultVerificationException, XCodeException,
        MojoExecutionException
  {
<span class="nc bnc" id="L204" title="All 2 branches missed.">    for (final String configuration : getConfigurations())</span>
    {
<span class="nc bnc" id="L206" title="All 2 branches missed.">      for (final String sdk : getSDKs())</span>
      {
<span class="nc bnc" id="L208" title="All 2 branches missed.">        if (sdk.startsWith(&quot;iphoneos&quot;))</span>
        {
<span class="nc" id="L210">          File versionsXmlInBuild = new File(project.getBuild().getDirectory(), &quot;versions.xml&quot;);</span>
<span class="nc" id="L211">          File versionsPListInBuild = new File(project.getBuild().getDirectory(), &quot;versions.plist&quot;);</span>

<span class="nc" id="L213">          File rootDir = XCodeBuildLayout.getAppFolder(getXCodeCompileDirectory(), configuration, sdk);</span>

<span class="nc" id="L215">          String productName = getProductName(configuration, sdk);</span>
<span class="nc" id="L216">          File appFolder = new File(rootDir, productName + &quot;.app&quot;);</span>
<span class="nc" id="L217">          File versionsXmlInApp = new File(appFolder, &quot;versions.xml&quot;);</span>
<span class="nc" id="L218">          File versionsPListInApp = new File(appFolder, &quot;versions.plist&quot;);</span>

<span class="nc" id="L220">          CodeSignManager.verify(appFolder);</span>
<span class="nc" id="L221">          final ExecResult originalCodesignEntitlementsInfo = CodeSignManager</span>
            .getCodesignEntitlementsInformation(appFolder);
<span class="nc" id="L223">          final ExecResult originalSecurityCMSMessageInfo = CodeSignManager.getSecurityCMSInformation(appFolder);</span>

<span class="nc" id="L225">          FileUtils.copyFile(versionsXmlInBuild, versionsXmlInApp);</span>
<span class="nc" id="L226">          getLog().info(&quot;Versions.xml file copied from: '&quot; + versionsXmlInBuild + &quot; ' to ' &quot; + versionsXmlInApp);</span>
<span class="nc" id="L227">          FileUtils.copyFile(versionsPListInBuild, versionsPListInApp);</span>
<span class="nc" id="L228">          getLog().info(&quot;Versions.plist file copied from: '&quot; + versionsPListInBuild + &quot; ' to ' &quot; + versionsPListInApp);</span>

<span class="nc" id="L230">          sign(rootDir, configuration, sdk);</span>

<span class="nc" id="L232">          final ExecResult resignedCodesignEntitlementsInfo = CodeSignManager</span>
            .getCodesignEntitlementsInformation(appFolder);
<span class="nc" id="L234">          final ExecResult resignedSecurityCMSMessageInfo = CodeSignManager.getSecurityCMSInformation(appFolder);</span>
<span class="nc" id="L235">          CodeSignManager.verify(appFolder);</span>
<span class="nc" id="L236">          CodeSignManager.verify(originalCodesignEntitlementsInfo, resignedCodesignEntitlementsInfo);</span>
<span class="nc" id="L237">          CodeSignManager.verify(originalSecurityCMSMessageInfo, resignedSecurityCMSMessageInfo);</span>
<span class="nc" id="L238">        }</span>
      }
    }
<span class="nc" id="L241">  }</span>

  private void sign(File rootDir, String configuration, String sdk) throws IOException, XCodeException
  {
<span class="nc" id="L245">    String csi = EffectiveBuildSettings.getBuildSetting(</span>
          getXCodeContext(XCodeContext.SourceCodeLocation.WORKING_COPY, configuration, sdk), EffectiveBuildSettings.CODE_SIGN_IDENTITY);
<span class="nc" id="L247">    File appFolder = new File(EffectiveBuildSettings.getBuildSetting(</span>
          getXCodeContext(XCodeContext.SourceCodeLocation.WORKING_COPY, configuration, sdk), EffectiveBuildSettings.CODESIGNING_FOLDER_PATH));
<span class="nc" id="L249">    CodeSignManager.sign(csi, appFolder, true);</span>
<span class="nc" id="L250">  }</span>

  private List&lt;Dependency&gt; getDependencies() throws IOException
  {

<span class="nc" id="L255">    List&lt;Dependency&gt; result = new ArrayList&lt;Dependency&gt;();</span>

    for (@SuppressWarnings(&quot;rawtypes&quot;)
<span class="nc bnc" id="L258" title="All 2 branches missed.">    final Iterator it = project.getDependencyArtifacts().iterator(); it.hasNext();) {</span>

<span class="nc" id="L260">      final Artifact mainArtifact = (Artifact) it.next();</span>

<span class="nc" id="L262">      org.sonatype.aether.artifact.Artifact sideArtifact = null;</span>

      try {

<span class="nc" id="L266">        sideArtifact = new XCodeDownloadManager(projectRepos, repoSystem,</span>
              repoSession).resolveSideArtifact(mainArtifact, &quot;versions&quot;, &quot;xml&quot;);

<span class="nc" id="L269">        getLog().info(&quot;Version information retrieved for artifact: &quot; + mainArtifact);</span>

<span class="nc" id="L271">        result.add(VersionInfoXmlManager.parseDependency(sideArtifact.getFile()));</span>
      }
<span class="nc" id="L273">      catch (SAXException e) {</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">        getLog().warn(String.format(&quot;Version file '%s' for artifact '%s' contains invalid content (Non parsable XML). Ignoring this file.&quot;, (sideArtifact != null ? sideArtifact.getFile() : &quot;&lt;n/a&gt;&quot;), sideArtifact));</span>
      }
<span class="nc" id="L276">      catch (JAXBException e) {</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">        getLog().info(String.format(&quot;Version file '%s' for artifact '%s' contains invalid content (Scheme violation). Ignoring this file.&quot;, (sideArtifact != null ? sideArtifact.getFile() : &quot;&lt;n/a&gt;&quot;), sideArtifact));</span>
      }
<span class="nc" id="L279">      catch (SideArtifactNotFoundException e) {</span>
<span class="nc" id="L280">        getLog().warn(&quot;Could not retrieve version information for artifact:&quot; + mainArtifact);</span>
<span class="nc" id="L281">      }</span>
<span class="nc" id="L282">    }</span>
<span class="nc" id="L283">    return result;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>